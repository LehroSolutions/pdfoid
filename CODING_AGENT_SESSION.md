# PDFoid Coding Agent Session: Session Initialization & Context

## 1. ULTRATHINK: Deep Reasoning & Architectural Invariants

### 1.1 Technical Logic: The Dual-Layer Sync
The project relies on a strictly decoupled but visually synchronized dual-layer architecture:
*   **Base Layer (PDFViewer):** Powered by `pdf.js`. It renders static snapshots of the PDF to a `<canvas>`. It is treated as "Read-Only" from the UI perspective.
*   **Interaction Layer (AnnotationCanvas):** A transparent overlay that captures clicks, draws vectors, and renders search result highlights.
*   **Invariant:** All interactive elements (annotations, highlights) **MUST** use normalized coordinates `(0.0 to 1.0)`. Converting to pixels must only happen inside the `render` loop based on the `targetCanvas.getBoundingClientRect()` and the current `DevicePixelRatio`.

### 1.2 Psychological Strategy: User Trust through Persistence
Users editing PDFs have a high "data loss anxiety." 
*   **Mechanism:** `annotationStore.ts` uses a debounced IndexedDB synchronization. 
*   **Strategy:** Toasts in `uiStore.ts` are used sparingly but critically for "Saved" and "Exported" states to reinforce the feeling of data safety.

### 1.3 Scalability & Performance: The Revision Loop
PDF mutation (via `pdf-lib`) is expensive and happens on byte buffers. Every mutation in `pdfEditorStore.ts` bumps a `pdfRevision` counter.
*   **Reasoning:** React is not built to track internal byte changes in a `Uint8Array`. The `pdfRevision` key forces a clean remount of the `PDFViewer`, ensuring the `pdf.js` worker re-parses the latest bytes. Do not attempt to "hot-patch" the `pdf.js` instance; favor the clean remount.

---

## 2. Core Constraints & Methodology

### 2.1 State Management (Zustand + Immer)
*   **Stores:** `pdfEditorStore` (document), `annotationStore` (edits), `uiStore` (view state).
*   **Policy:** Never modify state directly. Use the provided actions. For complex mutations in `pdfEditorStore`, use the `withPdfDocument` wrapper to ensure binary integrity and `pdfRevision` updates.

### 2.2 UI Philosophy: Avant-Garde Minimalism
*   **The Look:** High-contrast, distinctive typography, and generous whitespace.
*   **The Library:** Utilize the pre-installed UI primitives in `src/components/ui/` (likely Radix/Shadcn based on the "Senior Developer & Architect Guidelines").
*   **Spacing:** Follow the `--pdfoid-*` CSS variables defined in [src/styles.css](src/styles.css).

### 2.3 Accessibility (Non-Negotiable)
*   Canvas elements are invisible to AT (Assistive Technology).
*   **Requirement:** Ensure `AnnotationList.tsx` provides a screen-reader-accessible alternative to the `AnnotationCanvas.tsx` visuals.

---

## 3. High-Priority Agent Missions

1.  **Mission: Mutation Integrity:** When adding new PDF mutation features (e.g., merging, splitting), ensure they are wrapped in `withPdfDocument` to trigger the global refresh.
2.  **Mission: Coordinate Purity:** Audit any new tool to ensure no absolute pixel values are being written to the `annotationStore`. Use `getNormalizedCoords` helpers.
3.  **Mission: Local-First AI:** Extend `src/utils/ai.ts` using local models (WebGPU/Wasm) where possible. Maintain the privacy-first stance described in [README.md](README.md).

---

## 4. Environment Checklist
*   **Stack:** React 18, Vite, TypeScript, Tailwind, Zustand, pdf.js, pdf-lib.
*   **Test Suite:** Vitest for units/integration, Playwright for E2E.
*   **Persistence:** IndexedDB (for annotations), Memory (for PDF bytes until explicit save).

---
*Generated by GitHub Copilot â€” February 4, 2026*
